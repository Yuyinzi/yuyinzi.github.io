<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Python拾遗(1) | Yuyinzi&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="读《Python源码分析》的一些记录。">
<meta name="keywords" content="Python">
<meta property="og:type" content="article">
<meta property="og:title" content="Python拾遗(1)">
<meta property="og:url" content="http://yuyinzi.github.io/2019/04/10/Python拾遗-1/index.html">
<meta property="og:site_name" content="Yuyinzi&#39;s blog">
<meta property="og:description" content="读《Python源码分析》的一些记录。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-04-12T07:27:15.161Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python拾遗(1)">
<meta name="twitter:description" content="读《Python源码分析》的一些记录。">
  
    <link rel="alternate" href="/atom.xml" title="Yuyinzi&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yuyinzi.github.io"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Yuyinzi&#39;s blog</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Python拾遗-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/10/Python拾遗-1/" class="article-date">
  <time datetime="2019-04-10T07:46:27.000Z" itemprop="datePublished">2019-04-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Python拾遗(1)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>读《<code>Python</code>源码分析》的一些记录。<br><a id="more"></a></p>
<h2 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h2><p><code>python</code>会在模块载入时将源码编译成字节码，然后字节码会被虚拟机在核心函数中解释执行。<br>虚拟机开始运行时，通过初始化函数完成整个运行环境设置，包括：</p>
<ul>
<li>创建<code>__builtlin__</code>模块，持有所有内置类型和函数</li>
<li>创建<code>sys</code>模块</li>
<li>初始化内置<code>Exception</code></li>
<li>创建<code>__main__</code>模块，准备所需名字空间</li>
<li>通过<code>site.py</code>将<code>site-packages</code>中的第三方扩展库添加到搜索路径列表</li>
<li>执行入口<code>py</code>文件，执行前将<code>__main__.__dict__</code>作为名字空间传递进去</li>
<li>程序执行结束后执行清理操作</li>
</ul>
<h2 id="类型和对象"><a href="#类型和对象" class="headerlink" title="类型和对象"></a>类型和对象</h2><p>每个对象都包含一个标准头，通过头部信息就可以明确知道其具体类型。头部信息由“引用计数”和“类型指针”组成。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">0x1234</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.getsizeof(x)</span><br><span class="line"><span class="number">24</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.getrefcount(x)    //作为形参也会增加一次引用计数</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y = x</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.getrefcount(x)</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> y</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.getrefcount(x)</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>所有内置类型对象都能从<code>types</code>模块中找到，<code>int</code>、<code>long</code>、<code>str</code>都可以看做是简短别名：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> types</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">20</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(x) <span class="keyword">is</span> types.IntType</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x.__class__</span><br><span class="line">&lt;type <span class="string">'int'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x.__class__ <span class="keyword">is</span> type(x)</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x.__class__ <span class="keyword">is</span> int</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x.__class__ <span class="keyword">is</span> types.IntType</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></p>
<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><p>实际上<code>python</code>中，名字实际上是字符串对象，和所指向的目标对象在命名空间中构成<code>{name: object}</code>关联。它有多种命名空间，比如<code>globals</code>(模块命名空间)，<code>locals</code>函数堆栈帧命名空间，以及<code>class</code>、<code>instance</code>等。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>globals()</span><br><span class="line">&#123;<span class="string">'__builtins__'</span>: &lt;module <span class="string">'__builtin__'</span> (built-<span class="keyword">in</span>)&gt;, <span class="string">'__package__'</span>: <span class="literal">None</span>, <span class="string">'sys'</span>: &lt;module <span class="string">'sys'</span> (built-<span class="keyword">in</span>)&gt;, <span class="string">'x'</span>: <span class="number">123</span>, <span class="string">'__name__'</span>: <span class="string">'__main__'</span>, <span class="string">'__doc__'</span>: <span class="literal">None</span>, <span class="string">'types'</span>: &lt;module <span class="string">'types'</span> <span class="keyword">from</span> <span class="string">'/usr/lib/python2.7/types.pyc'</span>&gt;&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>globals()[<span class="string">"y"</span>] = <span class="string">"hello"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y</span><br><span class="line"><span class="string">'hello'</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>名字的作用仅仅是在某个时刻与名字空间的某个对象进行关联。其本身不包含目标对象的任何信息，只有通过对象头部的类型指针才能获得其具体类型。因此可以在运行期随时将其关联到任何类型对象。</p>
</blockquote>
<p>在函数外部时，<code>locals()</code>和<code>globals()</code>作用完全相同，在函数内部调用时，<code>locals()</code>则是获取当前函数堆栈帧的命名空间，其中存储的是函数参数、局部变量等。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(x)</span>:</span></span><br><span class="line"><span class="meta">... </span>    y = x + <span class="number">100</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> locals()</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> globals() <span class="keyword">is</span> locals()</span><br><span class="line"><span class="meta">... </span>    frame = sys._getframe(<span class="number">0</span>)     <span class="comment"># 获取当前堆栈帧</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> locals() <span class="keyword">is</span> frame.f_locals</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">print</span> globals() <span class="keyword">is</span> frame.f_globals</span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>test(<span class="number">123</span>)</span><br><span class="line">&#123;<span class="string">'y'</span>: <span class="number">223</span>, <span class="string">'x'</span>: <span class="number">123</span>&#125;</span><br><span class="line"><span class="literal">False</span></span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></p>
<p>在函数内部中调用<code>globals()</code>时，总是获取包含该函数定义的模块命名空间，而非调用处的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test.py</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">a = <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> &#123;k:v <span class="keyword">for</span> k, v <span class="keyword">in</span> globals().items() <span class="keyword">if</span> k != <span class="string">"__builtins__"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># test1.py</span></span><br><span class="line"><span class="keyword">import</span> test</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> test.test()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">&#123;<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'__file__'</span>: <span class="string">'/home/may/study/test.py'</span>, <span class="string">'__package__'</span>: <span class="literal">None</span>, <span class="string">'test'</span>: &lt;function test at <span class="number">0x7f6fc1119848</span>&gt;, <span class="string">'__name__'</span>: <span class="string">'test'</span>, <span class="string">'__doc__'</span>: <span class="literal">None</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以通过<code>&lt;module&gt;.__dict__</code>访问其他模块的命名空间。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.modules[__name__].__dict__ <span class="keyword">is</span> globals() //当前模块命名空间和globals相同</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></p>
<p>然而使用命名空间管理上下文，虽然能带来灵活性，但是相比指针低效很多，因此牺牲了一部分的执行性能。</p>
<h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><p><code></code>python<code>采用内存池减少操作系统内存分配和回收操作，小于等于</code>256<code>字节对象，将直接从内存池中获取存储空间。根据需要，虚拟机每次从操作系统申请一块</code>256kb<code>的内存(</code>areana<code>)，并且根据系统页划分为多个</code>pool<code>。每个</code>pool<code>分割成以</code>8<code>为倍数的</code>block<code>，这是内存池的最小单位。
大于</code>256<code>字节的对象，直接使用</code>malloc<code>在堆上分配内存。
当</code>areana<code>总容量超出</code>64MB<code>时，不再请求新的</code>arena<code>，而是直接在堆上为对象分配内存。完全空闲的</code>arena`会被释放交还给操作系统。</p>
<h3 id="引用传递"><a href="#引用传递" class="headerlink" title="引用传递"></a>引用传递</h3><p>对象总是按引用传递，即通过复制指针来实现多个名字指向同一对象。因为<code>arena</code>是在堆上分配的，所以无论何种类型何种大小的对象，都存储在堆上。因此，没有值类型和引用类型的区分。<br>不可变类型：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int, long, str, tuple, frozenset</span><br></pre></td></tr></table></figure></p>
<h3 id="深拷贝与浅拷贝"><a href="#深拷贝与浅拷贝" class="headerlink" title="深拷贝与浅拷贝"></a>深拷贝与浅拷贝</h3><blockquote>
<p>浅拷贝是对引用的拷贝(<strong>仅复制对象自身，而不会递归复制其成员</strong>)，深拷贝是对对象资源的拷贝。</p>
</blockquote>
<p>需要注意的是：</p>
<ul>
<li>不可变类型当修改时会创建新的对象，产生新的地址</li>
<li>切片操作<code>[:]</code>，使用工厂函数<code>list/dict/set</code>以及<code>copy()</code>都会产生浅拷贝的效果</li>
</ul>
<p><strong>赋值</strong>操作：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">57</span>]: will = [<span class="string">"will"</span>, <span class="number">28</span>, [<span class="string">"python"</span>, <span class="string">"c#"</span>, <span class="string">"javascript"</span>]]</span><br><span class="line"></span><br><span class="line">In [<span class="number">58</span>]: wilber = will</span><br><span class="line"></span><br><span class="line">In [<span class="number">59</span>]: wilber <span class="keyword">is</span> will</span><br><span class="line">Out[<span class="number">59</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">60</span>]: print(id(will),id(wilber))</span><br><span class="line"><span class="number">140110220425032</span> <span class="number">140110220425032</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">61</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> will])</span><br><span class="line">[<span class="number">140110445106880</span>, <span class="number">10912032</span>, <span class="number">140110220811400</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">62</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> wilber])</span><br><span class="line">[<span class="number">140110445106880</span>, <span class="number">10912032</span>, <span class="number">140110220811400</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">63</span>]: will[<span class="number">0</span>] = <span class="string">'wilber'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">64</span>]: print(id(will),id(wilber))</span><br><span class="line"><span class="number">140110220425032</span> <span class="number">140110220425032</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">65</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> will])</span><br><span class="line">[<span class="number">140110221716032</span>, <span class="number">10912032</span>, <span class="number">140110220811400</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">66</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> wilber])</span><br><span class="line">[<span class="number">140110221716032</span>, <span class="number">10912032</span>, <span class="number">140110220811400</span>]</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>赋值操作相当于将两个指针都指向了同一个地址</p>
</blockquote>
<p><strong>浅拷贝</strong>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">67</span>]: <span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">In [<span class="number">68</span>]: wilber = copy.copy(will)</span><br><span class="line"><span class="comment"># 浅拷贝会创建一个新的对象</span></span><br><span class="line">In [<span class="number">69</span>]: print(id(will),id(wilber))</span><br><span class="line"><span class="number">140110220425032</span> <span class="number">140110470159432</span></span><br><span class="line"><span class="comment"># 对于对象中的元素，只会使用原始元素的内存地址</span></span><br><span class="line">In [<span class="number">70</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> will])</span><br><span class="line">[<span class="number">140110221716032</span>, <span class="number">10912032</span>, <span class="number">140110220811400</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">71</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> wilber])</span><br><span class="line">[<span class="number">140110221716032</span>, <span class="number">10912032</span>, <span class="number">140110220811400</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">72</span>]: will[<span class="number">0</span>] = <span class="string">'will'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">73</span>]: will[<span class="number">2</span>].append(<span class="string">'css'</span>)</span><br><span class="line"><span class="comment"># 对不可变对象的修改会创建新的对象，对可变对象的修改会影响新的对象</span></span><br><span class="line">In [<span class="number">74</span>]: will, wilber</span><br><span class="line">Out[<span class="number">74</span>]: </span><br><span class="line">([<span class="string">'will'</span>, <span class="number">28</span>, [<span class="string">'python'</span>, <span class="string">'c#'</span>, <span class="string">'javascript'</span>, <span class="string">'css'</span>]],</span><br><span class="line"> [<span class="string">'wilber'</span>, <span class="number">28</span>, [<span class="string">'python'</span>, <span class="string">'c#'</span>, <span class="string">'javascript'</span>, <span class="string">'css'</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="number">75</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> will])</span><br><span class="line">[<span class="number">140110445106880</span>, <span class="number">10912032</span>, <span class="number">140110220811400</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">76</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> wilber])</span><br><span class="line">[<span class="number">140110221716032</span>, <span class="number">10912032</span>, <span class="number">140110220811400</span>]</span><br></pre></td></tr></table></figure></p>
<p><strong>深拷贝</strong>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">77</span>]: wilber = copy.deepcopy(will)</span><br><span class="line"></span><br><span class="line">In [<span class="number">78</span>]: print(id(will),id(wilber))</span><br><span class="line"><span class="number">140110220425032</span> <span class="number">140110423481608</span></span><br><span class="line"><span class="comment"># 即使是对象中的可变对象，也会重新生成一份</span></span><br><span class="line">In [<span class="number">79</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> will])</span><br><span class="line">[<span class="number">140110445106880</span>, <span class="number">10912032</span>, <span class="number">140110220811400</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">80</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> wilber])</span><br><span class="line">[<span class="number">140110445106880</span>, <span class="number">10912032</span>, <span class="number">140110220285128</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">81</span>]: will[<span class="number">0</span>] = <span class="string">'wilber'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">82</span>]: will[<span class="number">2</span>].append(<span class="string">'java'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">83</span>]: will, wilber</span><br><span class="line">Out[<span class="number">83</span>]: </span><br><span class="line">([<span class="string">'wilber'</span>, <span class="number">28</span>, [<span class="string">'python'</span>, <span class="string">'c#'</span>, <span class="string">'javascript'</span>, <span class="string">'css'</span>, <span class="string">'java'</span>]],</span><br><span class="line"> [<span class="string">'will'</span>, <span class="number">28</span>, [<span class="string">'python'</span>, <span class="string">'c#'</span>, <span class="string">'javascript'</span>, <span class="string">'css'</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="number">84</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> will])</span><br><span class="line">[<span class="number">140110221716032</span>, <span class="number">10912032</span>, <span class="number">140110220811400</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">85</span>]: print([id(element) <span class="keyword">for</span> element <span class="keyword">in</span> wilber])</span><br><span class="line">[<span class="number">140110445106880</span>, <span class="number">10912032</span>, <span class="number">140110220285128</span>]</span><br></pre></td></tr></table></figure></p>
<h4 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h4><p>当引用计数为<code>0</code>时，将立即回收该对象内存，要么将对应的<code>block</code>标记为空闲，要么返还给操作系统，在回收时会调用<code>__del__</code>方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>            <span class="keyword">print</span> <span class="string">"dead"</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = User()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.getrefcount(a)</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> a</span><br><span class="line">dead</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>某些内置类型，比如小整数，因为缓存的缘故，计数永远不会为0，直到进程结束才由虚拟机清理函数释放。<code>python</code>还支持弱引用，允许在不增加引用计数，不妨碍对象回收的情况下间接引用对象。但是<code>list</code>、<code>dict</code>弱引用会引发异常。</p>
</blockquote>
<h3 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h3><p>引用计数无法回收循环引用的对象，因此在对象群组内部使用弱引用有时能避免出现引用循环。它与强引用相对，是指不能确保其引用的对象不会被垃圾回收器回收的引用。一个对象若只被弱引用所引用，则可能在任何时候被回收。<strong>弱引用的主要作用就是减少循环时引用，减少内存中不必要的对象存在的数量。</strong><br>创建弱引用可以通过<code>weakref</code>模块的<code>ref(obj[,callback])</code>来创建弱引用，<code>obj</code>是想弱引用的对象，<code>callback</code>是一个可选的函数。当没有引用导致<code>python</code>要销毁这个对象时，调用<code>callback</code>，<code>callback</code>要求单个参数(弱引用的对象)。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> weakref</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Man</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>o = Man()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.getrefcount(o)</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = weakref.ref(o)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.getrefcount(o)</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r</span><br><span class="line">&lt;weakref at <span class="number">0x7f14e2558a48</span>; to <span class="string">'instance'</span> at <span class="number">0x7f14e24dc830</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>o1 = r()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>o1 <span class="keyword">is</span> o</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.getrefcount(o)</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>o = <span class="literal">None</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>o1 = <span class="literal">None</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.getrefcount(o)</span><br><span class="line"><span class="number">2548</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r</span><br><span class="line">&lt;weakref at <span class="number">0x7f14e2558a48</span>; dead&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h3><p>除了引用计数，还有专门处理循环引用的<code>GC</code>。一般能引发循环引用问题的，都是容器类对象，例如<code>list</code>、<code>set</code>、<code>object</code>。当不存在循环引用时，理论上可以禁用<code>GC</code>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> gc</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gc.disable()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(object)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(r)</span>:</span> <span class="keyword">print</span> r, <span class="string">"dead"</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gc.disable()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = User(); wa = weakref.ref(a, callback)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = User(); wb = weakref.ref(b, callback)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.b = b; b.a = a;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> a; <span class="keyword">del</span> b;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>wa(), wb()</span><br><span class="line">(&lt;__main__.User object at <span class="number">0x7f14e24e1190</span>&gt;, &lt;__main__.User object at <span class="number">0x7f14e24e11d0</span>&gt;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gc.enable()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gc.isenabled()</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gc.collect()</span><br><span class="line">&lt;weakref at <span class="number">0x7f14e2558b50</span>; dead&gt; dead</span><br><span class="line">&lt;weakref at <span class="number">0x7f14e2558ba8</span>; dead&gt; dead</span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure>
<p><code>GC</code>将要回收的对象分成<code>3</code>级：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> gc</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gc.get_threshold()</span><br><span class="line">(<span class="number">700</span>, <span class="number">10</span>, <span class="number">10</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gc.get_count()</span><br><span class="line">(<span class="number">263</span>, <span class="number">9</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>包含<code>__del__</code>方法的循环引用对象，永远不会被<code>GC</code>回收，直至进程终止。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(r)</span>:</span> <span class="keyword">print</span> r, <span class="string">"dead!"</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gc.set_debug(gc.DEBUG_STATS | gc.DEBUG_LEAK)   <span class="comment"># 输出详细的回收状态信息</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gc.isenabled()</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = User(); wa = weakref.ref(a, callback)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = User(); wb = weakref.ref(b, callback)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.b = b; b.a = a</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> a; <span class="keyword">del</span> b</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>gc.collect()                                </span><br><span class="line">gc: collecting generation <span class="number">2.</span>..</span><br><span class="line">gc: objects <span class="keyword">in</span> each generation: <span class="number">10</span> <span class="number">0</span> <span class="number">3637</span></span><br><span class="line">gc: uncollectable &lt;User <span class="number">0x7f14e24e1210</span>&gt;            <span class="comment"># a</span></span><br><span class="line">gc: uncollectable &lt;User <span class="number">0x7f14e24e1250</span>&gt;            <span class="comment"># b</span></span><br><span class="line">gc: uncollectable &lt;dict <span class="number">0x7f14e2550b40</span>&gt;            <span class="comment"># a.__dict__</span></span><br><span class="line">gc: uncollectable &lt;dict <span class="number">0x7f14e2550910</span>&gt;            <span class="comment"># b.__dict__</span></span><br><span class="line">gc: done, <span class="number">4</span> unreachable, <span class="number">4</span> uncollectable, <span class="number">0.0023</span>s elapsed.</span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>要运行<code>python</code>程序，必须将源码编译成字节码。通常情况下，编译器会将源码转化成字节码后保存在<code>pyc</code>文件中。编译发生在模块载入那一刻。</p>
<ul>
<li><p>载入<code>pyc</code>流程：</p>
<ul>
<li>核对文件<code>Magic</code>标记(由<code>Python</code>版本号计算得来)</li>
<li>检查时间戳和源码文件修改时间是否相同，以确定是否需要重新编译</li>
<li>载入模块</li>
</ul>
</li>
<li><p>如果没有<code>pyc</code>，需要先进行编译</p>
<ul>
<li>对源码进行<code>AST</code>分析</li>
<li>将分析结果编译成<code>PyCodeObject</code></li>
<li>将<code>Magic</code>、源码文件修改时间、<code>PyCodeObject</code>保存到<code>pyc</code>文件中</li>
<li>载入模块</li>
</ul>
</li>
</ul>
<p><code>PyCodeObject</code>包含了代码对象的完整信息。内部成员嵌入到<code>co_consts</code>列表中。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yuyinzi.github.io/2019/04/10/Python拾遗-1/" data-id="cjue0k6ab000gt08zmowoj0vy" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li></ul>

    </footer>
  </div>
  
    
 <script src="/jquery/jquery.min.js"></script>
  <div id="random_posts">
    <h2>推荐文章</h2>
    <div class="random_posts_ul">
      <script>
          var random_count =4
          var site = {BASE_URI:'/'};
          function load_random_posts(obj) {
              var arr=site.posts;
              if (!obj) return;
              // var count = $(obj).attr('data-count') || 6;
              for (var i, tmp, n = arr.length; n; i = Math.floor(Math.random() * n), tmp = arr[--n], arr[n] = arr[i], arr[i] = tmp);
              arr = arr.slice(0, random_count);
              var html = '<ul>';
            
              for(var j=0;j<arr.length;j++){
                var item=arr[j];
                html += '<li><strong>' + 
                item.date + ':&nbsp;&nbsp;<a href="' + (site.BASE_URI+item.uri) + '">' + 
                (item.title || item.uri) + '</a></strong>';
                if(item.excerpt){
                  html +='<div class="post-excerpt">'+item.excerpt+'</div>';
                }
                html +='</li>';
                
              }
              $(obj).html(html + '</ul>');
          }
          $('.random_posts_ul').each(function () {
              var c = this;
              if (!site.posts || !site.posts.length){
                  $.getJSON(site.BASE_URI + 'js/posts.js',function(json){site.posts = json;load_random_posts(c)});
              } 
               else{
                load_random_posts(c);
              }
          });
      </script>
    </div>
  </div>

    
<nav id="article-nav">
  
    <a href="/2019/04/10/Python拾遗-2/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          Python拾遗(2)
        
      </div>
    </a>
  
  
    <a href="/2019/04/10/《Redis设计与实现》读书笔记-第一部分/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">《Redis设计与实现》读书笔记 第一部分</div>
    </a>
  
</nav>

  
</article>
 
   <!-- 
  <div class="comments" id="comments">
    
     
       
       
      
      
  </div>
  -->
  

</section>
           
    <aside id="sidebar">
  
    

  
    
    <div class="widget-wrap">
    
      <div class="widget" id="toc-widget-fixed">
      
        <strong class="toc-title">文章目录</strong>
        <div class="toc-widget-list">
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#虚拟机"><span class="toc-number">1.</span> <span class="toc-text">虚拟机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#类型和对象"><span class="toc-number">2.</span> <span class="toc-text">类型和对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#命名空间"><span class="toc-number">3.</span> <span class="toc-text">命名空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存管理"><span class="toc-number">4.</span> <span class="toc-text">内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#引用传递"><span class="toc-number">4.1.</span> <span class="toc-text">引用传递</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#深拷贝与浅拷贝"><span class="toc-number">4.2.</span> <span class="toc-text">深拷贝与浅拷贝</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#引用计数"><span class="toc-number">4.2.1.</span> <span class="toc-text">引用计数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#弱引用"><span class="toc-number">4.3.</span> <span class="toc-text">弱引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#垃圾回收"><span class="toc-number">4.4.</span> <span class="toc-text">垃圾回收</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译"><span class="toc-number">5.</span> <span class="toc-text">编译</span></a></li></ol>
          </div>
      </div>
    </div>

  
    

  
    
  
    
  
    

  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2019 Littlemay&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;littlemay2015@gmail.com
    </div>
  </div>
</footer>
 <script src="/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    <img class="back-to-top-btn" src="/images/fly-to-top.png">
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>
      

  

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->



 <script src="/js/is.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/elevator.js"></script>
  </div>
</body>
</html>